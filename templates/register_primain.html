{% extends "base.html" %}
{% block title %}Register New Primain{% endblock %}
{% block content %}
<header>
    <h1>Register New Primain</h1>
</header>
<main>
    <form id="primain-form" method="POST">
        <div>
            <label for="primain_name">Desired Primain:</label>
            <input type="text" id="primain_name" name="primain_name" placeholder="E.g. dog.tree.water" required>
        </div>
        <div class="field-with-button">
            <label for="address">Address:</label>
            <input type="text" id="address" name="address" placeholder="Enter your address" required>
            <button type="button" id="import-address" class="small-button">Import Address</button>
        </div>
        <div class="field-with-button">
            <label for="proof">Proof:</label>
            <input type="hidden" id="proof" name="proof" value="">
            <input type="text" id="proof_display" name="proof_display" placeholder="Proof will be displayed here" readonly>
            <button type="button" id="sign-proof" class="small-button">Generate Proof</button>
        </div>
        <button type="submit" class="form-button">Register</button>
    </form>
    <a href="/" class="back-button">Back</a>
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("import-address").addEventListener("click", function() {
        if (typeof window.ethereum !== 'undefined') {
            // Request access to MetaMask
            ethereum.request({ method: 'eth_requestAccounts' })
            .then(function(accounts) {
                // Access granted, set the first account as the address
                document.getElementById("address").value = accounts[0];
                console.log("Address imported:", accounts[0]);
                alert("Address imported: " + accounts[0]); // Provide feedback to the user
            })
            .catch(function(error) {
                console.error("Error requesting accounts:", error);
                alert("Error requesting accounts: " + error.message); // Inform the user of the error
            });
        } else {
            console.error("MetaMask not available");
            alert("MetaMask is not available. Please install MetaMask to import the address."); // Inform the user that MetaMask is not available
        }
    });

    document.getElementById("sign-proof").addEventListener("click", function() {
        var primainName = document.getElementById("primain_name").value;
        var address = document.getElementById("address").value;
        var message = primainName + address;

        if (typeof window.ethereum !== 'undefined') {
            // Request access to MetaMask if not already connected
            ethereum.request({ method: 'eth_requestAccounts' })
            .then(function(accounts) {
                // Access granted, proceed with signature request
                ethereum.request({
                    method: 'personal_sign',
                    params: [message, ethereum.selectedAddress],
                }).then(function(result) {
                    // Set the signature as the value of the proof input field
                    document.getElementById("proof").value = result;
                    document.getElementById("proof_display").value = result;
                    console.log("Signature generated:", result);
                    alert("Signature generated: " + result); // Provide feedback to the user
                }).catch(function(error) {
                    console.error("Error signing message:", error);
                    alert("Error signing message: " + error.message); // Inform the user of the error
                });
            })
            .catch(function(error) {
                console.error("Error requesting accounts:", error);
                alert("Error requesting accounts: " + error.message); // Inform the user of the error
            });
        } else {
            console.error("MetaMask not available");
            alert("MetaMask is not available. Please install MetaMask to sign messages."); // Inform the user that MetaMask is not available
        }
    });
});
</script>
{% endblock %}
